---
date: 2024-01-21
today: Slack은 메세지를 어떻게 주고 받는지 분석해보았다. 왜 http를 통해 요청하고 ws로 다시 응답받는 구조로 설계했을까?
---

# DND
- k8s 관련 공부 키워드
	- kubernetes 리소스 어떤 게 있는지 좋은지
	- pod, deployment, service 개념
	- kubectl 사용 방법

# 뮤밍
## Slack 메세지 요청 시스템 파악

**서비스 특징**
1. 현재 작성 중인 메세지도 저장이 된다
2. 입력 중 상태가 존재한다
3. 유저의 활성 상태가 존재한다


### 알아낸 사실들

1. 웹소켓 연결은 최초로 한 번만 발생한다.
소켓을 통한 모든 공통 필드로 `type`이 존재한다.
확인된 바로는
- send
	- flannel : ?
	- presence_sub : `ids` 필드 통해 id 리스트를 보내는데, DM채널인 듯. on/off 라인 표시해야 해서 그런 게 아닐까?
	- ping : 주기적으로 보냄
	- tickle : 메세지 입력 창을 클릭했을 때 발생
	- user_typing : 유저가 메세지 입력하고 있을 때 발생
- receive
	- hello : 웹소켓 첫 연결 성공 시 맨 처음으로 응답 받는 메세지
	- presence_change : 활성 상태 변화를 감지하는 타입
		- presence
			- `"away"` : DM 리스트에서 유저가 활성 상태였다가 Off 가 되었을 때 응답 받는다.
			- `"active"` : DM 리스트에서 유저가 비활성 상태였다가 On 이 되었을 때 응답 받는다.
	- pong : ping의 응답
	- pref_change : 설정이 변경된 경우
	- `*`draft_create : 작성 중인 초안이 서버에 저장되었다고 알려줌
	- `*`draft_update : 작성 중인 초안이 서버에 변경되었다고 알려줌
	- `*`draft_delete : 작성 중인 초안이 서버에서 삭제되었다고 알려줌
	- `*`file_created : 파일 업로드 완료 시 알려 줌
	- `*`file_deleted : 업로드된 파일 삭제 완료 시 알려 줌


2. http를 통해 요청하고, websocket을 통해 응답 받는다.
특이한 점이 웹소켓을 통해서"만" 서버와 소통하는 것이 아닌 http와 WS를 적절하게 섞어 사용한다.

1번에서 `*`로 표시해 놓은 receive 들이 그렇다.
draft 생성의 경우, 유저가 타이핑을 시작하다가 멈춘 후 약 10초 후에 초안 생성 POST 요청을 보낸다. 
서버에 초안이 생성되면 WS으로부터 아까 요청의 응답과 같은 응답을 또 받는다.

메세지에 file을 첨부한 경우, files.getUploadURL 이라는 path로 POST 요청을 보내고, 응답으로 파일 url을 바로 받는다.
이 url을 통해서 실제 파일 업로드가 수행된다. 이 요청은 파일 크기에 따라 오래 걸리는 작업이다. 이 요청이 성공적으로 응답되면 files.completeUpload 이라는 Path로 POST 요청을 보낸다. 
그럼 WS로부터 `file_created` 타입의 응답이 도착한다.

http 요청의 응답과 웹소켓의 응답이 거의 동일한 데이터라서 왜 응답을 중복으로 받는지 이해가 잘 되지 않았다.

추측해보자면, 슬랙에서 발생하는 이벤트가 독립적으로 구성되어 있어서 그런 게 아닐까?
슬랙 메세지 창에서 어떤 이벤트가 발생하면, 메세지창은 해당 이벤트를 발산할 뿐 callback을 받지 않는 구조인 것이 아닐까.
하지만 메세지 창은 웹소켓을 알고 있고, 그래서 이 웹소켓을 통해서만 메세지를 응답 받는 구조?


3. 메세지 타입 - 텍스트만 있을 때와 파일이 함께 있을 경우 데이터 구조는 어떻게 되나?

- 메세지 구조
	- type : `"message"` 외에 어떤 메세지가 있는지 확인이 안된다.
	- text: 텍스트가 있다면 존재한다. 없으면 `""`
	- blocks: [슬랙 메세지에서 hover하면 음영처리되는 부분]의 리스트, 텍스트가 없다면 필드가 내려오지 않는다.
		- elements: [불릿, 숫자 리스트, 텍스트 등 구분되는 요소] 리스트
			- style : element 스타일(불릿, 숫자 리스트 등)
	- files: 첨부된 파일 리스트
		- created
		- id: 파일에 부여된 유니크 아이디
		- mimetype: "image/png"
		- filetype: "png"
		- title: 파일 이름
		- thumb_64: "https:~"

