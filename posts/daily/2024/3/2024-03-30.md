---
date: 2024-03-30
today: mongoTemplateì˜ findAndModify ì¿¼ë¦¬ë¥¼ í†µí•´ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ê³  í–ˆìœ¼ë‚˜, upsertì˜ ì¡°ê±´ê³¼ ë³µì¡í•œ ë°ì´í„° êµ¬ì¡°ë¡œ ì¸í•´ì„œ ì‹¤íŒ¨í–ˆë‹¤. ì°¨ì•ˆìœ¼ë¡œ upsertë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šê³  insert ì™€ updateë¥¼ ë¶„ë¦¬í•˜ì—¬ ì‘ì—…í–ˆë‹¤.
---
## ë³µì¡í•œ ì¿¼ë¦¬ì˜ upsertëŠ” ë¶ˆê°€ëŠ¥í•œê±¸ê¹Œ

ê¸°ì¡´ì— ëŒ€ì‹œë³´ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì¹´ìš´íŒ…ì´ 0ìœ¼ë¡œ ì„¸íŒ…ëœ ëŒ€ì‹œë³´ë“œë¥¼ ë¨¼ì € ìƒì„±í•œ í›„ì—, ì—…ë°ì´íŠ¸ ë¡œì§ì„ ëª¨ë‘ ê±°ì¹˜ê²Œ í–ˆì—ˆë‹¤.

ì´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ë”°ë¥´ë©´ì„œ upsertë¥¼ í•˜ë ¤ê³  í•˜ë‹ˆ, `ConflictingUpdateOperators` ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.
í•˜ë‚˜ì˜ `Update` ì—°ì‚° ë‚´ì—ì„œ ê°™ì€ í•„ë“œì— ëŒ€í•´ ì„œë¡œ ë‹¤ë¥¸ ëª…ë ¹ì„ ë™ì‹œì— ìˆ˜í–‰í•˜ë ¤ê³  í–ˆê¸° ë•Œë¬¸ì´ë‹¤.
 `$setOnInsert`ë¥¼ í†µí•´ì„œ í•„ë“œë¥¼ ì´ˆê¸°í™”í•˜ê³  `$inc`ë¥¼ í†µí•´ì„œ ì´ˆê¸°í™”í–ˆë˜ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ë ¤ê³  í–ˆëŠ”ë° ê·¸ê²Œ í•˜ë‚˜ì˜ ì—°ì‚°ìœ¼ë¡œëŠ” ë¶ˆê°€ëŠ¥í•œ ê²ƒì´ë‹¤.

í•˜ì§€ë§Œ setOnInsertë¡œ í•„ë“œë¥¼ ì´ˆê¸°í™” í•´ì£¼ì§€ ì•Šìœ¼ë©´ updateí•  ë•Œ í•´ë‹¹ ê°ì²´ ë§¤í•‘í•  ìˆ˜ ì—†ë‹¤ê³  ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë°œìƒí•œë‹¤. insertë  ë•Œ ì œëŒ€ë¡œëœ ê°ì²´ë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ì„œ ê·¸ë ‡ë‹¤.

```
org.springframework.data.mapping.model.MappingInstantiationException: Failed to instantiate com.dnd.namuiwiki.domain.statistic.model.Statistic using constructor public com.dnd.namuiwiki.domain.statistic.model.Statistic(java.lang.String,com.dnd.namuiwiki.domain.question.type.QuestionName,com.dnd.namuiwiki.domain.dashboard.type.DashboardType,java.lang.Long) with arguments null,null,null,1
```

ê²°êµ­ upsertì„ ì´ìš©í•˜ëŠ” ê±¸ í¬ê¸°í–ˆë‹¤. insertì™€ update ë¡œì§ì„ ë¶„ë¦¬í–ˆë‹¤.
ì´ ë•Œ ë¬¸ì œì ì€ insert ì‹œì— ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ì¤‘ë³µ ìƒì„±ì´ ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

ê·¸ë˜ì„œ ëŒ€ì‹œë³´ë“œ ì»¬ë ‰ì…˜ì— indexë¥¼ unique ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì—ˆë‹¤. ìƒì„±ë³´ë‹¤ëŠ” ì¡°íšŒ í›„ ì—…ë°ì´íŠ¸ê°€ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•  ê²ƒì´ë¼ì„œ ì¸ë±ìŠ¤ ìƒì„±í•´ë„ ë¬´ë°©í•  ê²ƒ ê°™ë‹¤.
ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•œë‹¤ê³  ë™ì‹œì„± ë¬¸ì œê°€ í•´ê²°ë˜ëŠ” ê²ƒì€ ì•„ë‹ˆì§€ë§Œ, ì¤‘ë³µ ìƒì„±ì€ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•´ì„œ ì‚½ì…í•˜ì§€ ëª»í•˜ë©´, í†µê³„ ì—…ë°ì´íŠ¸ ì—ëŸ¬ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ì—ì„œ ì¶”ê°€ ì²˜ë¦¬í•´ì£¼ë©´ ë  ê²ƒ ê°™ë‹¤.

ëª¨ë‘ ì ìš©í•œ í›„ í…ŒìŠ¤íŠ¸ì½”ë“œ ëŒë ¤ë³´ë‹ˆ ì„±ê³µí–ˆë‹¤ ğŸ˜†
ëŒ€ì‹  ì²˜ìŒ ìƒì„±í•˜ëŠ” ê²½ìš°ì—ëŠ” ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šê²Œ ë”°ë¡œ ì²˜ë¦¬í•´ì£¼ì—ˆë‹¤.

```java
@ParameterizedTest  
@DisplayName("periodì™€ relation í•„í„° ì ìš©í•˜ì§€ ì•Šì€ ëŒ€ì‹œë³´ë“œëŠ” ì„¤ë¬¸ì´ ìƒì„±ë˜ëŠ” ìˆ˜ë§Œí¼ totalCountê°€ ì¦ê°€í•œë‹¤.")  
@ValueSource(ints = {5, 10})  
void updateTotalCountBySurveySize(int surveySize) throws InterruptedException {  
	  
	// given  
	Period period = Period.INFINITE;  
	Relation relation = Relation.ELEMENTARY_SCHOOL;  
	User owner = User.builder().id("testId").wikiId("wikiId").build();  
	  
	Survey survey = Survey.builder()  
			.owner(owner)  
			.senderName("ê¹€ì² ìˆ˜")  
			.period(period)  
			.relation(relation)  
			.answers(makeAnswerList())  
			.build();  
	  
	// when  
	int numberOfThreads = surveySize - 1;  
	ExecutorService service = Executors.newFixedThreadPool(numberOfThreads);  
	  
	statisticsService.updateStatistics(survey);  
	for (int i = 0; i < numberOfThreads; i++) {  
		service.execute(() -> statisticsService.updateStatistics(survey));  
	}  
	  
	service.shutdown();  
	boolean finished = service.awaitTermination(1000, TimeUnit.MINUTES);  
	  
	assertTrue(finished);  
	  
	// then  
	Dashboard dashboard = dashboardRepository.findByUserAndPeriodAndRelation(owner, null, null).orElseThrow();  
	Statistic statistic = dashboard.getStatistics().getStatisticsByDashboardType(DashboardType.BEST_WORTH).get(0);  
	  
	Long totalCount = statistic.getTotalCount();  
	assertThat(totalCount).isEqualTo(surveySize);  
	  
}
```


![](2024-03-30-20240330182342585.png)

