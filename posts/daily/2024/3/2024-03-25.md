---
date: 2024-03-25
today: 남의위키의 숨겨진 문제들을 파악하고 해결 방안을 모색한다.
---

## 발생할 수 있는 문제들

현재 남의위키에서 발생할 수 있는 문제가 2가지 있다.

### 1. 동시성 문제 발생

이전([240316](https://eun-seong.vercel.app/daily/2024-03-16))에 확인했던 문제이다. 

현재 누군가 설문을 작성 완료 요청을 하면, 서버에서 수행하는 작업이 2가지이다.

1. 설문 document 생성
2. 사용자 대시보드 및 통계 document 업데이트

MongoDB 사용하고 있는데, 트랜잭션을 사용할 수 없는 환경이라서 2번에서 데이터가 덮어써질 수 있다.

한 사용자에게 2명의 사용자가 거의 동시에 설문 생성을 하면, 하나의 document를 2개의 스레드가 모두 접근하여 수정하려고 해서 발생하는 일이다.

이건 `findAndModify`를 사용하면 해결 가능할 것 같다. 이걸 사용하려면 mongo Template 사용하도록 수정이 필요하다.

### 2. 데이터 누락

이것도 트랜잭션이 없어서 발생하는 문제이다.

1. 설문 document 생성
2. 사용자 대시보드 및 통계 document 업데이트

설문 작성 완료 시 수행하는 이 2가지 작업에서 2번에서 에러가 발생한다면?

사용자가 설문한 내용이 저장은 됐는데, 통계 업데이트가 안되어서 실제 통계와 사용자에게 보여지는 통계 데이터가 다르게 된다. 

만약 트랜잭션이 적용 가능한 환경이었다고 해도, 이걸 트랜잭션으로 해결하는 건 최선의 판단이 아니라고 생각했다. 왜냐하면 1번과 2번은 완전히 다른 작업이기 때문이다. 사용자는 자신의 설문이 생성되기를 요청한 것이지, 2번이 실패했다고 해서 1번까지 실패로 처리할 필요는 없는 것이다. (그래서 2번 작업도 비동기 이벤트 기반으로 변경한 상태이다.)

해결 방안을 모색하면서, 통계 업데이트가 실시간으로 반영되어야 하는지 고민해보았다.

통계 업데이트는 다시 2가지 작업으로 나뉜다.
1. 개별 사용자의 대시보드 업데이트 (개인 통계량)
2. 전체 사용자의 통계 업데이트 (전체 통계량)

1번은 실시간성이 필요하다고 생각했다. 대시보드의 목적이 그것이니까.     
2번은 실시간성이 필요하지 않다고 생각했다. 전체 통계량의 실시간 정확도가 개별 사용자에게 중요한 부분은 아니라서 하루에 한 번 정도만 업데이트해줘도 되지 않을까 싶었다.

그래서 아래와 같이 시도해보면 어떨까 싶다.
1. 실시간성이 필요한 개인 통계량 업데이트는, fallback 테이블을 만들어놓고 에러가 발생할 경우 해당 데이터를 쌓아 주기적으로 배치를 돌린다.
2. 실시간성이 필요하지 않는 전체 통계량 업데이트는 설문이 생성될 때마다 업데이트하지 않고 하루에 한 번씩 배치를 돌려준다.

 