---
date: 2024-03-16
today: 비동기 환경에서 mongoDB의 데이터를 업데이트하는데 동시성 문제가 발생했다. 이제라도 발견해서 다행이다.
---

## mongoDB 데이터 업데이트 동시성 문제

남의위키 베타 런칭 후에 몇몇 버그 덕분에 제대로된 통계가 집계되지 않았었다.
그래서 몇몇 유저들은 잘못된 데이터를... 보고 있을 것이다...

버그는 수정해서 배포했지만, 이전 데이터를 활용해서 데이터를 업데이트하기 때문에 이대로 두면 안되겠다 싶었다.
그래서 한 번 DB를 엎어서 현재 들어온 설문들을 토대로 통계량을 다시 계산해서 넣어주는 작업을 진행하기로 했다.


이미 대시보드를 업데이트하는 로직은 모두 있으니, 설문들만 가져와서 대시보드 업데이트하는 로직을 한 번씩 실행해주면 되겠거니 했다.
그래서 아래와 같은 코드를 작성했다.
```java
@Async  
@EventListener  
public void handleResetDashboardEvent(ResetDashboardEvent event) {  
	log.info("SurveyHandler.handleResetDashboardEvent");  
	  
	dashboardRepository.deleteAll();  
	surveyRepository.findAll().forEach(dashboardService::updateStatistics);  
	  
	log.info("SurveyHandler.handleResetDashboardEvent done");
}
```

그리고 테스트를 해보았다.
설문은 똑같은 유저 소유로 6개가 있었기 때문에, 대시보드는 3개가 생성되어야 했다.

그런데 18개가 생성되었다 😟
처음에는 repository에서 메소드를 실행할 때 뭔가 병렬적으로 실행되나? 이런 생각이 들었다.
forEach에 대해서도 다시 찾아보고, 중단점 찍어서 디버깅도 해보았는데 원인을 발견하지 못했다.

그 때 `updateStatistics` 메소드에 붙어 있던 `@Async`를 발견했다.
그래서 Async를 지우고 다시 시도해보니 정상적으로 3개가 생성되었다. 
그 후에 다시 Async를 붙이고 dashboard를 삭제하지 않고, 그대로 업데이트를 해보았다.
정상적인 결과는 하나의 document 각각 counting이 6개씩 증가해야 한다. 하지만 어떨 땐 5개, 어떨 땐 6개가 증가되는 등 비정상적인 결과가 보여졌다.


처음에는 좀 의아했다.
대시보드 업데이트를 할 때, 찾는 대시보드가 없으면 생성해서 저장해놓고 그 대시보드를 사용해 업데이트한다.
현재 우리가 트랜잭션을 사용할 수 없는 환경이긴하지만, mongoDB는 하나의 document의 원자성을 보장한다고 했다.
그래서 대시보드 업데이트를 할 때(이미 존재하는 document일 경우)는 문제가 발생하지 않을 줄 알았다. 이미 존재하는 dashboard를 가져와서 업데이트할 때는 비동기이더라도 원자성이 보장될 거라 생각했다.

그런데 내가 원자성의 의미를 부정확하게 알고 있는 거였더라.
원자성은 1 or 0이다. 전부 실행되거나 전부 실행이 되지않는 것이다. 
mongoDB에서는 도큐먼트 레벨에서 원자성을 보장한다는 말은, 하나의 document 내에서 발생하는 수정 사항들이 전체 반영되거나 실패할 경우 전체 반영하지 않는다는 것이다.

그래서 비동기 환경에서는 하나의 스레드가 업데이트를 해도, 다른 스레드가 업데이트한 데이터로 덮어 쓰여질 수 있다는 것이다.

이걸 `@Async`를 없애서 동기로 변경한다고 해결되는 문제는 아니다.
만약 여러 사용자가 똑같은 알게된 경로와 기간으로 설정하고 똑같은 유저에게 거의 동시에 요청하게 되면 이와 같은 문제가 발생할 수 있다. http 요청이 들어오면 요청마다 각기 다른 스레드를 사용하기 때문이다.



해결하려면 mongoDB의 조회와 수정을 한 번에 하는 `findAndModify` 메소드를 사용하면 된다고 한다.
현재는 repository를 사용하고 있어서, 이 메소드를 사용하려고 하면 template으로 변경해주어야 한다. 그리고 dashboard 업데이트하는 로직을 적용하는 코드에서 변경사항이 있을 것 같다.






